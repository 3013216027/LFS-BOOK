<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-scripts-systemd-custom">
  <?dbhtml filename="systemd-custom.html"?>

  <title>Systemd 的用法与配置</title>

  <indexterm zone="ch-scripts-systemd-custom">
    <primary sortas="e-Systemd">Systemd 配置</primary>
  </indexterm>

  <sect2>
    <title>基础配置</title>

    <para><filename>/etc/systemd/system.conf</filename> 文件包含了大量的 systemd 控制命令。
    假如未作任何的更改，文件中的所有行应该都是注释掉的，这代表了 systemd 正使用默认的运行方式。
    这个文件中可以设置日志级别，可以修改日志的基本设置。所有设置项都可以在 man 手册的 <filename>systemd-system.conf(5)</filename> 中查看。</para>

  </sect2>

  <sect2>
    <title>禁用启动时清屏</title>

    <para>默认情况下，systemd 将会在系统启动快要结束的时候清屏。如不需要，使用以下操作禁用：</para>

<screen role="nodump"><userinput>mkdir -pv /etc/systemd/system/getty@tty1.service.d

cat &gt; /etc/systemd/system/getty@tty1.service.d/noclear.conf &lt;&lt; EOF
<literal>[Service]
TTYVTDisallocate=no</literal>
EOF</userinput></screen>

    <para>拥有 root 权限的账户总是可以通过 <userinput>journalctl -b</userinput> 查看启动信息。</para>

  </sect2>

  <sect2>
    <title>禁止 /tmp 使用 tmpfs</title>

    <para>默认情况下，<filename class="directory">/tmp</filename> 使用 tmpfs 文件系统。如不需要，使用以下操作禁用：</para>

<screen role="nodump"><userinput>ln -sfv /dev/null /etc/systemd/system/tmp.mount</userinput></screen>

    <para>如果已经为 <filename class="directory">/tmp</filename> 在 <filename>/etc/fstab</filename> 中指定了专门的分区，
    那么此操作是多余的。</para>

  </sect2>

  <sect2>
    <title>配置自动创建和删除文件</title>

    <para>有这样几个服务可以建立或删除文件/目录：</para>

    <itemizedlist>
      <listitem><para>systemd-tmpfiles-clean.service</para></listitem>
      <listitem><para>systemd-tmpfiles-setup-dev.service</para></listitem>
      <listitem><para>systemd-tmpfiles-setup.service</para></listitem>
    </itemizedlist>

    <para>系统配置文件在 <filename>/usr/lib/tmpfiles.d/*.conf</filename> 中。
      本地配置文件在 <filename class="directory">/etc/tmpfiles.d</filename> 中。
      <filename class="directory">/etc/tmpfiles.d</filename>中的文件会覆盖 <filename class="directory">/usr/lib/tmpfiles.d</filename> 中相同名称的文件。
      （译者注：首先读取系统范围配置文件，再读取用户范围配置文件，用户范围配置文件会覆盖系统范围配置文件的相同部分。）可以在 man 手册的 <filename>tmpfiles.d(5)</filename> 中获取文件格式详情。</para>

  </sect2>

  <sect2>
    <title>覆盖默认服务的行为</title>

    <para>可以通过在 <filename class="directory">/etc/systemd/system</filename> 下新建配置文件的方法改变 systemd 服务的默认行为。例如：</para>

<screen role="nodump"><userinput>mkdir -pv /etc/systemd/system/foobar.service.d

cat > /etc/systemd/system/foobar.service.d/foobar.conf &lt;&lt; EOF
<literal>[Service]
Restart=always
RestartSec=30</literal>
EOF</userinput></screen>

     <para>可以在 man 手册的 <filename>systemd.unit(5)</filename> 中查询更多信息。创建好文件之后，请运行 <userinput>systemctl daemon-reload</userinput> 和 <userinput>systemctl restart foobar</userinput> 激活所做更改。</para>

  </sect2>

  <sect2>
    <title>调试启动顺序</title>

    <para>有一些命令可以帮助分析 systemd 启动进程，例如：</para>

    <itemizedlist>
       <listitem><para>systemctl list-units -t service [--all]</para></listitem>
       <listitem><para>systemctl list-units -t target  [--all]</para></listitem>
       <listitem><para>systemctl show -p Wants multi-user.target</para></listitem>
       <listitem><para>systemctl status sshd.service</para></listitem>
    </itemizedlist>

  </sect2>

</sect1>
